pipeline {
  agent {
    kubernetes {
      yamlFile ".ngci/agent-amd64.yaml"
    }
  }

  // parameters {
  //   booleanParam(name: "TAG_VERSION_AS_LATEST", defaultValue: true,  description: "Sets the version tag to 'latest' (disable to use the Jenkins `BUILD_NUMBER` as version)")
  //   booleanParam(name: "PUSH_DOCKER_IMAGE",     defaultValue: false, description: "If to push (publish) the built Docker image")
  // }

  // environment {
  //   DOCKER_IMAGE_REGISTRY                = "https://index.docker.io/v1/"
  //   DOCKER_IMAGE_REGISTRY_CREDENTIALS_ID = "dockerhub-maze88"
  //   DOCKER_IMAGE_NAME                    = "maze88/echo-server"
  //   DOCKER_IMAGE_TAG                     = "${params.TAG_VERSION_AS_LATEST ? "latest" : env.BUILD_NUMBER}"
  // }

  options {
    timeout(time: 30, unit: "MINUTES")
  }

  stages {
    stage("Build") {
      steps {
        container("kaniko") {
          sh("pwd; ls -l; env; which executor; which kaniko; /kaniko/executor")
        }
      }
    }

    // stage("Publish") {
    //   when {
    //     anyOf {
    //       branch "main"
    //       expression { params.PUSH_DOCKER_IMAGE }
    //     }
    //   }
    //   steps {
    //     withCredentials([usernamePassword(credentialsId: "${env.DOCKER_IMAGE_REGISTRY_CREDENTIALS_ID}", usernameVariable: "USERNAME", passwordVariable: "PASSWORD")]) {
    //       sh("echo '${PASSWORD}' | docker login -u ${USERNAME} --password-stdin ${DOCKER_IMAGE_REGISTRY}")
    //     }
    //     sh("docker push ${env.DOCKER_IMAGE_NAME}:${env.DOCKER_IMAGE_TAG}")
    //   }
    // }
  }
}

