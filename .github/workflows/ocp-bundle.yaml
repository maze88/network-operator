# TODO: when done remove ~/projects/jenkins-confs/jenkins-files/network-operator/ocp-bundle-push.jenkinsfile
name: Package OCP Bundle

on:
  push:
    branches:
    - "feature/ocp-bundle"  # TODO: remove before merging
    - "master"
    tags:
    - "v[0-9]+.[0-9]+.[0-9]+*"  # TODO: safe to remove wild card from end of pattern?

jobs:
  ocp-package:
    runs-on: ubuntu-latest
    env:
      DEFAULT_BRANCH: master
      REGISTRY: nvcr.io/nvstaging/mellanox
      IMAGE_NAME: network-operator
      # BUNDLE_REGISTRY: harbor.mellanox.com/cloud-orchestration-dev  # noam angel approved to change to nvstaging; requested we PoC it
      BUNDLE_IMAGE_NAME: network-operator-bundle
    steps:
    - uses: actions/checkout@v4
    - if: github.ref_name == env.DEFAULT_BRANCH
      name: Determine docker tag (when git branch)
      run: |
        echo VERSION_WITH_PREFIX=latest           >> $GITHUB_ENV
        echo VERSION_WITHOUT_PREFIX=latest >> $GITHUB_ENV
    - if: github.ref_type == 'tag'
      name: Determine docker tag (when git tag)
      run: |
        version=${{ github.ref_name }}
        echo VERSION_WITH_PREFIX=$version               >> $GITHUB_ENV
        echo VERSION_WITHOUT_PREFIX=${version:1} >> $GITHUB_ENV  # without the 'v' prefix
    - uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.NVCR_USERNAME }}
        password: ${{ secrets.NVCR_TOKEN }}
    - name: Make bundle
      env:
        TAG: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ env.VERSION_WITH_PREFIX }}  # TODO: validate env var substituion successful
        BUNDLE_IMG: ${{ env.REGISTRY }}/${{ env.BUNDLE_IMAGE_NAME }}:${{ env.VERSION_WITH_PREFIX }}
        DEFAULT_CHANNEL: stable
        CHANNELS: stable,${{ env.VERSION_WITH_PREFIX }}
        VERSION: ${{ env.VERSION_WITHOUT_PREFIX }}
      run: |
        env           # TODO: validate all above env vars are properly created with their full values
        which jq      # TODO: where is this even required?
        which skopeo  # TODO: where is this even required?

        echo "Docker tag will be: $DOCKER_TAG"  # TODO: add bundle sanity echo too
        make image release-build bundle bundle-build # bundle-push  # TODO: only push when build result is satisfying
